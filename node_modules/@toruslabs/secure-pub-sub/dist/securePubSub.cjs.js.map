{"version":3,"file":"securePubSub.cjs.js","mappings":"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","sources":["webpack://@toruslabs/secure-pub-sub/external commonjs2 \"@babel/runtime/helpers/defineProperty\"","webpack://@toruslabs/secure-pub-sub/external commonjs2 \"@toruslabs/eccrypto\"","webpack://@toruslabs/secure-pub-sub/external commonjs2 \"@toruslabs/http-helpers\"","webpack://@toruslabs/secure-pub-sub/external commonjs2 \"@toruslabs/metadata-helpers\"","webpack://@toruslabs/secure-pub-sub/external commonjs2 \"socket.io-client\"","webpack://@toruslabs/secure-pub-sub/external commonjs2 \"loglevel\"","webpack://@toruslabs/secure-pub-sub/./src/log.ts","webpack://@toruslabs/secure-pub-sub/./src/SecurePubSub.ts","webpack://@toruslabs/secure-pub-sub/webpack/bootstrap","webpack://@toruslabs/secure-pub-sub/webpack/runtime/compat get default export","webpack://@toruslabs/secure-pub-sub/webpack/runtime/define property getters","webpack://@toruslabs/secure-pub-sub/webpack/runtime/hasOwnProperty shorthand","webpack://@toruslabs/secure-pub-sub/webpack/runtime/make namespace object","webpack://@toruslabs/secure-pub-sub/./src/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@babel/runtime/helpers/defineProperty\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@toruslabs/eccrypto\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@toruslabs/http-helpers\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"@toruslabs/metadata-helpers\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"socket.io-client\");","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"loglevel\");","import log from \"loglevel\";\n\nexport default log.getLogger(\"SecurePubSub\");\n","import { getPublic, sign } from \"@toruslabs/eccrypto\";\nimport { post, setLogLevel } from \"@toruslabs/http-helpers\";\nimport { decryptData, encryptData, keccak256 } from \"@toruslabs/metadata-helpers\";\nimport { LogLevelDesc } from \"loglevel\";\nimport { io, type Socket } from \"socket.io-client\";\n\nimport { ISecurePubSubOptions, SetDataBody } from \"./interfaces\";\nimport log from \"./log\";\n\nexport class SecurePubSub {\n  options: ISecurePubSubOptions;\n\n  SOCKET_CONN: Socket | null = null;\n\n  constructor(options: ISecurePubSubOptions = {}) {\n    this.options = options;\n    this.options.timeout = options.timeout || 600; // 10 mins is default timeout\n    this.options.serverUrl = options.serverUrl || \"https://broadcast-server.tor.us\";\n    this.options.enableLogging = options.enableLogging || false;\n    this.options.namespace = options.namespace || \"\";\n    if (this.options.enableLogging) log.enableAll();\n    else log.disableAll();\n  }\n\n  static setLogLevel(level: LogLevelDesc) {\n    log.setLevel(level);\n    setLogLevel(level);\n  }\n\n  async publish(topic: string, message: string): Promise<void> {\n    const topicPrivKey = keccak256(Buffer.from(topic, \"utf8\"));\n    const encryptedData = await encryptData(topicPrivKey.toString(\"hex\"), message);\n    const signature = await sign(topicPrivKey, keccak256(Buffer.from(encryptedData, \"utf8\")));\n    const fetchBody: SetDataBody = {\n      key: getPublic(topicPrivKey).toString(\"hex\"), // already padded\n      data: encryptedData,\n      signature: signature.toString(\"hex\"),\n      timeout: this.options.timeout,\n      namespace: this.options.namespace,\n    };\n    return post(`${this.options.serverUrl}/channel/set`, fetchBody);\n  }\n\n  async subscribe(topic: string): Promise<string> {\n    let isPromisePending = true;\n    const topicPrivKey = keccak256(Buffer.from(topic, \"utf8\"));\n    const topicPubKey = getPublic(topicPrivKey).toString(\"hex\"); // already padded\n    const currentSocketConnection = this.getSocketConnection();\n    if (currentSocketConnection.connected) {\n      log.debug(\"already connected with socket\");\n      currentSocketConnection.emit(\"check_auth_status\", topicPubKey, { namespace: this.options.namespace });\n    } else {\n      currentSocketConnection.once(\"connect\", () => {\n        log.debug(\"connected with socket\");\n        currentSocketConnection.emit(\"check_auth_status\", topicPubKey, { namespace: this.options.namespace });\n      });\n    }\n\n    const reconnect = () => {\n      currentSocketConnection.once(\"connect\", async () => {\n        log.debug(\"connected with socket using reconnect\");\n        if (isPromisePending) currentSocketConnection.emit(\"check_auth_status\", topicPubKey, { namespace: this.options.namespace });\n      });\n    };\n\n    const visibilityListener = () => {\n      if (!isPromisePending) document.removeEventListener(\"visibilitychange\", visibilityListener);\n      // if not connected, then wait for connection and ping server for latest msg.\n      if (!currentSocketConnection.connected && document.visibilityState === \"visible\") {\n        reconnect();\n      }\n    };\n\n    const disconnectListener = () => {\n      log.debug(\"socket disconnected\", isPromisePending);\n      if (isPromisePending) {\n        log.error(\"socket disconnected unexpectedly, reconnecting socket\");\n        reconnect();\n      } else {\n        currentSocketConnection.removeListener(\"disconnect\", disconnectListener);\n      }\n    };\n\n    currentSocketConnection.on(\"disconnect\", disconnectListener);\n\n    const returnPromise = new Promise<string>((resolve, reject) => {\n      const listener = async (ev: string) => {\n        try {\n          const decData = await decryptData(topicPrivKey.toString(\"hex\"), ev);\n          log.info(\"got data\", decData);\n          resolve(decData as string);\n        } catch (error) {\n          log.error(error);\n          reject(error);\n        } finally {\n          isPromisePending = false;\n          document.removeEventListener(\"visibilitychange\", visibilityListener);\n        }\n      };\n      log.info(\"listening to\", `${topicPubKey}_success`);\n      currentSocketConnection.once(`${topicPubKey}_success`, listener);\n    });\n\n    if (typeof document !== \"undefined\") document.addEventListener(\"visibilitychange\", visibilityListener);\n    return returnPromise;\n  }\n\n  public cleanup() {\n    if (this.SOCKET_CONN) {\n      this.SOCKET_CONN.disconnect();\n      this.SOCKET_CONN = null;\n    }\n  }\n\n  private getSocketConnection(): Socket {\n    if (this.SOCKET_CONN) return this.SOCKET_CONN;\n    const localSocketConnection = io(this.options.serverUrl, {\n      transports: [\"websocket\", \"polling\"], // use WebSocket first, if available\n      withCredentials: true,\n      reconnectionDelayMax: 10000,\n      reconnectionAttempts: 10,\n    });\n\n    localSocketConnection.on(\"connect_error\", (err) => {\n      // revert to classic upgrade\n      localSocketConnection.io.opts.transports = [\"polling\", \"websocket\"];\n      log.error(\"connect error\", err);\n    });\n    localSocketConnection.on(\"connect\", async () => {\n      const { engine } = localSocketConnection.io;\n      log.debug(\"initially connected to\", engine.transport.name); // in most cases, prints \"polling\"\n      engine.once(\"upgrade\", () => {\n        // called when the transport is upgraded (i.e. from HTTP long-polling to WebSocket)\n        log.debug(\"upgraded\", engine.transport.name); // in most cases, prints \"websocket\"\n      });\n      engine.once(\"close\", (reason) => {\n        // called when the underlying connection is closed\n        log.debug(\"connection closed\", reason);\n      });\n    });\n\n    localSocketConnection.on(\"error\", (err) => {\n      log.error(\"socket errored\", err);\n      localSocketConnection.disconnect();\n    });\n\n    this.SOCKET_CONN = localSocketConnection;\n    return this.SOCKET_CONN;\n  }\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export * from \"./interfaces\";\nexport * from \"./SecurePubSub\";\n"],"names":["log","getLogger","getPublic","sign","post","setLogLevel","decryptData","encryptData","keccak256","io","SecurePubSub","constructor","options","arguments","length","undefined","_defineProperty","timeout","serverUrl","enableLogging","namespace","enableAll","disableAll","level","setLevel","publish","topic","message","topicPrivKey","Buffer","from","encryptedData","toString","signature","fetchBody","key","data","subscribe","isPromisePending","topicPubKey","currentSocketConnection","getSocketConnection","connected","debug","emit","once","reconnect","visibilityListener","document","removeEventListener","visibilityState","disconnectListener","error","removeListener","on","returnPromise","Promise","resolve","reject","listener","ev","decData","info","addEventListener","cleanup","SOCKET_CONN","disconnect","localSocketConnection","transports","withCredentials","reconnectionDelayMax","reconnectionAttempts","err","opts","engine","transport","name","reason"],"sourceRoot":""}